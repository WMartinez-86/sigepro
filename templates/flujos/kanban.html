{% extends 'base2.html' %}
{% block title %}
Kanban
{% endblock %}
{% block content %}

<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><style id="css_disabled_color_picker" type="text/css">.mColorPicker[disabled] + span, .mColorPicker[disabled="disabled"] + span, .mColorPicker[disabled="true"] + span {filter:alpha(opacity=50);-moz-opacity:0.5;-webkit-opacity:0.5;-khtml-opacity: 0.5;opacity: 0.5;cursor:default;}</style>
    <title>Sigepro - Tablero Kanban</title>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta name="keywords" content="kanban, agile, dashboard, board, SCRUM, visual kanban, virtual kanban, lean, tablero, tablero kanban">
    <meta name="description" content="Tablero Kanban">
    <script src="/estaticos/usuario/js/ga.js" async="" type="text/javascript"></script>
    <script src="/estaticos/usuario/js/jquery-1.js" type="text/javascript"></script>
    <script type="text/javascript" src="/estaticos/usuario/js/home.js">
    </script>

    <script src="/estaticos/usuario/js/jquery-ui.js" type="text/javascript">
    </script>
    <script type="text/javascript" src="/estaticos/usuario/js/mColorPicker_min.js" charset="UTF-8"></script>

    <link rel="stylesheet" href="/estaticos/usuario/css/kanban.css" type="text/css" media="all">
    <link rel="stylesheet" href="/estaticos/usuario/css/jquery-ui.css" type="text/css" media="all">
    <link rel="stylesheet" href="/estaticos/usuario/css/home.css" type="text/css" media="all">
    <link rel="stylesheet" href="/estaticos/usuario/css/bootstrap.css" type="text/css" media="all">
    <link href="/estaticos/usuario/css/css.css" rel="stylesheet" type="text/css">

    <link rel="stylesheet" type="text/css" href="/estaticos/usuario/css/base.css" />
    <link rel="stylesheet" type="text/css" href="/estaticos/usuario/css/changelists.css"/>

    <script type="text/javascript">window.__admin_media_prefix__ = "/estaticos/usuario/";</script>
    <script type="text/javascript" src="/estaticos/usuario/js/core.js"></script>
    <script type="text/javascript" src="/estaticos/usuario/js/jquery.js"></script>
    <script type="text/javascript" src="/estaticos/usuario/js/jquery.init.js"></script>
    <script type="text/javascript" src="/estaticos/usuario/js/actions.js"></script>
    <meta name="robots" content="NONE,NOARCHIVE" />

    <script src="/estaticos/usuario/js/google_analytics_auto.js"></script></head>

<script>
$(document).ready(function() {

	/* Manipulación de columnas */

	$('#add_col').click(function(){
		var id=$(".task_pool").size();
		$(".task_pool_header:last").addClass("dotted_separator");
		$(".task_pool:last").addClass("dotted_separator");

		$("#task_pool_header_container").append('<th class="task_pool_header"><div class="header_name click">'+id+'</div><div wip="0" class="WIP">WIP: Ilimitado</div></th>');
		$("#task_pool_container").append('<td class="task_pool"><div /></td>');
		intialize_sortables();
	});
	$('#remove_col').click(function(){
	   if($(".task_pool_header").size()>1){
	    	$(".task_pool_header").last().remove();
    		$(".task_pool").last().remove();

    		$(".task_pool_header:last").removeClass("dotted_separator");
			$(".task_pool:last").removeClass("dotted_separator");
		    intialize_sortables();
		}
	});

	$('.header_name').live('click',function(){
		var cur_name=$(this).children("span").html();
		var wip = $(this).parent().children("div:eq(1)").attr("wip");
		wip = check_number(wip);
		var header_new_html=' \
		<div class="header_input"> \
			Nombre<br/><input onkeypress="javascript:save_edit_h(event)" class="input header_input_name" value="'+cur_name+'" /> \
		</div>  \
		<div class="header_input"> \
			WIP<br/><input onkeypress="javascript:save_edit_h(event)" class="input header_input_name" value="'+wip+'" /> \
		</div>  \
		<div class="small"> \
			<div class="option save_header"><button class="btn btn-success btn-mini"><i class="icon-white icon-ok">&nbsp;</i></button></div> \
		</div> \
		<div class="clear"></div> \
		';
		$(this).parent().html(header_new_html);
	});
	$('.save_header').live('click',function(){
    	var index=$(this).parent().parent().index();
		var new_name=$(this).parent().parent().children("div:eq(0)").first().children(".input").first().val();
		var wip=$(this).parent().parent().children("div:eq(1)").first().children(".input").first().val();
		wip = check_number(wip);
		if(index==0){
		    wip=0; // Primera columna debe tener el wip ilimitado
		}
		if(wip>0){
    		$(this).parent().parent().html('<div class="header_name click"><img class="title_bullet" src="img/mookup/bullet.png" /><span class="title_text">'+new_name+'</span></div><div wip="'+wip+'" class="WIP">WIP: '+wip+'</div>');
		}else{
        	$(this).parent().parent().html('<div class="header_name click"><img class="title_bullet" src="img/mookup/bullet.png" /><span class="title_text">'+new_name+'</span></div><div wip="'+wip+'" class="WIP">WIP: Unlimited</div>');
    	}
	});

	/* Manipulación de tareas */
	$('#add_task').click(function(){
		var id=2;
		$(".task_pool").first().append(' \
		  <div class="big_container"> \
			  <div id="box_itm'+id+'"class="box_itm rounded"> \
				  <div id="name'+id+'" class="name">Item '+id+'</div> \
				  <div class="dotted_hr"></div> \
				  <div id="resp'+id+'" class="name">Resp '+id+'</div> \
				  <progress max="100" id="progress_bar'+id+'" class="pbar" value="0"></progress> \
				  <div class="small"> \
					  <div n="'+id+'" class="itm_box_option"><input n="'+id+'"  class="color colorete" type="color" data-text="hidden" data-colorlink="box_itm'+id+'" value="#f7941d"></div> \
					  <div n="'+id+'" class="option close itm_box_option"><button class="btn btn-danger btn-mini"><i class="icon-white icon-remove"></i></button></div> \
					  <div n="'+id+'" class="option edit itm_box_option"><button class="btn btn-info btn-mini"><i class="icon-white icon-pencil"></i></button></div> \
				  </div> \
				  <div class="clear"></div> \
			  </div> \
			  <div id="box_itm'+id+'_shadow" class="shadow" /> \
			<div> \
		');

		$( "#box_itm"+id+" .itm_box_option input" ).mColorPicker();
		$('.itm_box_option').hide();
	});

	$('.box_itm').live('mouseover',function(){
		$(this).children().children('.itm_box_option').show();
	});
	$('.box_itm').live('mouseout',function(){
		$('.itm_box_option').hide();
	});

	$('.colorete').live('colorpicked', function () {
    $('#box_itm'+$(this).attr('n')).css('background',$(this).val());
	});


	$(".save").live('click', function(){
		var id = $(this).attr("n");
		var box_itm_name=$('#name_input'+id).val();
		var box_itm_resp=$('#resp_input'+id).val();
		var pbar_value=parseInt($('#progress_input'+id).val());
		pbar_value = check_number(pbar_value);
		var box_itm_new_html=' \
		    <div class="big_container"> \
				  <div id="name'+id+'" class="name">'+box_itm_name+'</div> \
				  <div class="dotted_hr"></div> \
				  <div id="resp'+id+'" class="name">'+box_itm_resp+'</div> \
				  <progress max="100" id="progress_bar'+id+'" class="pbar" value="'+pbar_value+'"></progress> \
				  <div class="small"> \
				    <div n="'+id+'" class="itm_box_option"><input n="'+id+'"  class="color colorete" type="color" data-text="hidden" data-colorlink="box_itm'+id+'" value="#f7941d"></div> \
					  <div n="'+id+'" class="option close itm_box_option"><button class="btn btn-danger btn-mini"><i class="icon-white icon-remove"></i></button></div> \
					  <div n="'+id+'" class="option edit itm_box_option"><button class="btn btn-info btn-mini"><i class="icon-white icon-pencil"></i></button></div> \
				  </div> \
				  <div class="clear"></div> \
				<div> \
		';
		$('#box_itm'+id).html(box_itm_new_html);
		$( "#box_itm"+id+" .itm_box_option input" ).mColorPicker();

		$('#box_itm'+id).live('mouseover',function(){
		  $(this).children().children().children('.itm_box_option').show();
	  });
	  $('#box_itm'+id).live('mouseout',function(){
		  $('.itm_box_option').hide();
	  });

	  $('.colorete').live('colorpicked', function () {
      $('#box_itm'+$(this).attr('n')).css('background',$(this).val());
	  });

	});


	$('.edit').live('click', function() {
		var id = $(this).attr("n");
		var box_itm_name=$('#name'+id).html();
		var box_itm_resp=$('#resp'+id).html();
		var pbar_value=parseInt($('#progress_bar'+id).prop('value'));
		if (isNaN(pbar_value)){ var pbar_value=0;}
		var box_itm_new_html=' \
				<div><span class="small">Name of the task:</span><input onkeypress="javascript:save_edit(event)" id="name_input'+id+'" class="input" value="'+box_itm_name+'" /></div>  \
				<div><span class="small">Responsible:</span><input onkeypress="javascript:save_edit(event)" id="resp_input'+id+'" class="input" value="'+box_itm_resp+'" /></div>  \
				<div><span class="small">Progress:</span><input onkeypress="javascript:save_edit(event)" id="progress_input'+id+'" class="input" value="'+pbar_value+'" /></div>  \
				<div class="small"> \
					<div n="'+id+'" class="option save"><button class="btn btn-success btn-mini"><i class="icon-white icon-ok">&nbsp;</i></button></div> \
				</div> \
				<div class="clear"></div> \
		';
		$('#box_itm'+id).html(box_itm_new_html);
	});

	$('.close').live('click', function() {
		var id = $(this).attr("n");
		$('#box_itm'+id).remove();
		$('#box_itm'+id+'_shadow').remove();
	});

	$('#txt_btn').click(function(){
			$('#texto').toggle('slow');
	});

        intialize_sortables();
});

/* Funciones auxiliares */
function intialize_sortables(){
	$( ".task_pool" ).sortable({
			connectWith: ".task_pool",
			delay:25,
			revert:true,
			dropOnEmpty: true,
			forcePlaceHolderSize: true,
 			helper: 'clone',
 			forceHelperSize: true,
			receive: function(event, ui) {
					var itms= $(this).children(".big_container").length;
					var index=$(this).index();
					var wip=  $(this).parent().parent().children("tr th:eq("+index+")").children("div:eq(1)").first().attr("wip");
					wip = check_number(wip);
					if((wip!=0)&&(itms>wip))
					{
						$(ui.sender).sortable('cancel');
						//alert("WIP exceded");
					}
				}
	});
	$('.itm_box_option').hide();
};
function find_next_box_itm_free(id){
	if($('#box_itm'+id).length)
	{
		id++;
		return find_next_box_itm_free(id);
	}
	else
	{
		return id;
	}
}
function check_number(number){
    if(isNaN(number)||(number<0))
	{
		number=0;
	}
	else if (number>100)
	{
		number=100;
	}
	return number;
}

function save_edit(e){
	var code;
	if (!e) var e = window.event;
	if (e.keyCode) code = e.keyCode;
	else if (e.which) code = e.which;

	if(code==13) { $(".save").click(); }
}

function save_edit_h(e){
	var code;
	if (!e) var e = window.event;
	if (e.keyCode) code = e.keyCode;
	else if (e.which) code = e.which;

	if(code==13) { $(".save_header").click(); }
}

function addUserStory(nombre, desarrollador){
    {% for UserStory in userStories  %}
        var id=2;
        $(".task_pool").first().append(' \
              <div class="big_container"> \
                  <div id="box_itm'+id+'"class="box_itm rounded"> \
                      <div id="name'+id+'" class="name">{{ UserStory.nombre }} </div> \
                      <div class="dotted_hr"></div> \
                      <div id="resp'+id+'" class="name">{{ UserStory.desarrollador }} </div> \
                      <progress max="100" id="progress_bar'+id+'" class="pbar" value="0"></progress> \
                      <div class="small"> \
                          <div n="'+id+'" class="itm_box_option"><input n="'+id+'"  class="color colorete" type="color" data-text="hidden" data-colorlink="box_itm'+id+'" value="#f7941d"></div> \
                          <div n="'+id+'" class="option close itm_box_option"><button class="btn btn-danger btn-mini"><i class="icon-white icon-remove"></i></button></div> \
                          <div n="'+id+'" class="option edit itm_box_option"><button class="btn btn-info btn-mini"><i class="icon-white icon-pencil"></i></button></div> \
                      </div> \
                      <div class="clear"></div> \
                  </div> \
                  <div id="box_itm'+id+'_shadow" class="shadow" /> \
              <div> \
        ');
    {% endfor %}
}

</script>

<body class="background", onload="addUserStory()">

<table id="cabecera" align="center">

    <tbody><tr>
        <td colspan="2" align="center" size="15">
            <font size="8">Tablero Kanban</font>
        </td>
    </tr>
    </tbody></table>

<div id="main_div">
    <div>
        <input id="add_task" value="Nuevo user Story" class="btn btn-info" type="button">
        <input id="add_col" value="Nueva Actividad" class="btn btn-primary" type="button">
        <input id="remove_col" value="Borrar Columna" class="btn btn-danger" type="button">
    </div>

    <table class="table rounded" border="1">
        <tbody>
            <tr id="task_pool_header_container">
                <th class="task_pool_header  dotted_separator"><div class="header_name click"><img class="title_bullet" src="/estaticos/usuario/img/bullet.png"><span class="title_text">Backlog</span></div><div wip="0" class="WIP">WIP: Ilimitado</div></th>
                {% for Actividad in actividades  %}
                    <th class="task_pool_header  dotted_separator", colspan="3"><div class="header_name click"><img class="title_bullet" src="/estaticos/usuario/img/bullet.png"><span class="title_text">{{ Actividad.nombre }}</span></div><div wip="0" class="WIP">WIP: Ilimitado</div></th>
                {% endfor %}
                <th class="task_pool_header"><div class="header_name click"><img class="title_bullet" src="/estaticos/usuario/img/bullet.png"><span class="title_text">Terminado</span></div><div wip="0" class="WIP">WIP: Ilimitado</div></th>
            </tr>
            <tr id="states">
                <th class="task_pool_header  dotted_separator"></th>
                {% for Actividad in actividades  %}
                    <th class="task_pool_header  dotted_separator">To Do</th>
                    <th class="task_pool_header  dotted_separator">Doing</th>
                    <th class="task_pool_header  dotted_separator">Done</th>
                {% endfor %}
                <th class="task_pool_header  dotted_separator"><span class="title_text">{{ Actividad.nombre }}</span></th>
            </tr>
            <tr id="task_pool_container">
                <td class="task_pool dotted_separator ui-sortable"><div></div></td>
                {% for Actividad in actividades  %}
                    <td class="task_pool dotted_separator ui-sortable"><div></div></td>
                    <td class="task_pool dotted_separator ui-sortable"><div></div></td>
                    <td class="task_pool dotted_separator ui-s{ortable"><div></div></td>
                {% endfor %}
                <td class="task_pool ui-sortable"><div></div></td>
            </tr>

        </tbody>
    </table>


    <div style="display: none; background: none repeat scroll 0% 0% black; opacity: 0.01; position: absolute; top: 0px; right: 0px; bottom: 0px; left: 0px;" id="mColorPickerBg"></div>
    <div style="position: absolute; border: 1px solid rgb(204, 204, 204); color: rgb(255, 255, 255); width: 194px; height: 184px; font-size: 12px; font-family: times; display: none;" data-mcolorpicker="true" id="mColorPicker">
        <div style="position: relative; border: 1px solid gray;" id="mColorPickerWrapper">
            <div style="height: 136px; width: 192px; border: 0px none; cursor: crosshair; background-image: url(&quot;http://meta100.github.com/mColorPicker/images/picker.png&quot;);" class="mColor" id="mColorPickerImg"></div>
            <div style="border-right: 1px solid rgb(0, 0, 0);" id="mColorPickerSwatches">
                <div style="background-color: rgb(255, 255, 255); height: 18px; width: 18px; border: 1px solid rgb(0, 0, 0); float: left;" class="mPastColor" id="cell0">&nbsp;</div>
                <div style="background-color: rgb(255, 255, 0); height: 18px; width: 18px; border-width: 1px 1px 1px 0px; border-style: solid solid solid none; border-color: rgb(0, 0, 0) rgb(0, 0, 0) rgb(0, 0, 0) -moz-use-text-color; -moz-border-top-colors: none; -moz-border-right-colors: none; -moz-border-bottom-colors: none; -moz-border-left-colors: none; border-image: none; float: left;" class="mPastColor mNoLeftBorder" id="cell1">&nbsp;</div>
                <div style="background-color: rgb(0, 255, 0); height: 18px; width: 18px; border-width: 1px 1px 1px 0px; border-style: solid solid solid none; border-color: rgb(0, 0, 0) rgb(0, 0, 0) rgb(0, 0, 0) -moz-use-text-color; -moz-border-top-colors: none; -moz-border-right-colors: none; -moz-border-bottom-colors: none; -moz-border-left-colors: none; border-image: none; float: left;" class="mPastColor mNoLeftBorder" id="cell2">&nbsp;</div>
                <div style="background-color: rgb(0, 255, 255); height: 18px; width: 18px; border-width: 1px 1px 1px 0px; border-style: solid solid solid none; border-color: rgb(0, 0, 0) rgb(0, 0, 0) rgb(0, 0, 0) -moz-use-text-color; -moz-border-top-colors: none; -moz-border-right-colors: none; -moz-border-bottom-colors: none; -moz-border-left-colors: none; border-image: none; float: left;" class="mPastColor mNoLeftBorder" id="cell3">&nbsp;</div>
                <div style="background-color: rgb(0, 0, 255); height: 18px; width: 18px; border-width: 1px 1px 1px 0px; border-style: solid solid solid none; border-color: rgb(0, 0, 0) rgb(0, 0, 0) rgb(0, 0, 0) -moz-use-text-color; -moz-border-top-colors: none; -moz-border-right-colors: none; -moz-border-bottom-colors: none; -moz-border-left-colors: none; border-image: none; float: left;" class="mPastColor mNoLeftBorder" id="cell4">&nbsp;</div>
                <div style="background-color: rgb(255, 0, 255); height: 18px; width: 18px; border-width: 1px 1px 1px 0px; border-style: solid solid solid none; border-color: rgb(0, 0, 0) rgb(0, 0, 0) rgb(0, 0, 0) -moz-use-text-color; -moz-border-top-colors: none; -moz-border-right-colors: none; -moz-border-bottom-colors: none; -moz-border-left-colors: none; border-image: none; float: left;" class="mPastColor mNoLeftBorder" id="cell5">&nbsp;</div>
                <div style="background-color: rgb(255, 0, 0); height: 18px; width: 18px; border-width: 1px 1px 1px 0px; border-style: solid solid solid none; border-color: rgb(0, 0, 0) rgb(0, 0, 0) rgb(0, 0, 0) -moz-use-text-color; -moz-border-top-colors: none; -moz-border-right-colors: none; -moz-border-bottom-colors: none; -moz-border-left-colors: none; border-image: none; float: left;" class="mPastColor mNoLeftBorder" id="cell6">&nbsp;</div>
                <div style="background-color: rgb(76, 43, 17); height: 18px; width: 18px; border-width: 1px 1px 1px 0px; border-style: solid solid solid none; border-color: rgb(0, 0, 0) rgb(0, 0, 0) rgb(0, 0, 0) -moz-use-text-color; -moz-border-top-colors: none; -moz-border-right-colors: none; -moz-border-bottom-colors: none; -moz-border-left-colors: none; border-image: none; float: left;" class="mPastColor mNoLeftBorder" id="cell7">&nbsp;</div>
                <div style="background-color: rgb(59, 59, 59); height: 18px; width: 18px; border-width: 1px 1px 1px 0px; border-style: solid solid solid none; border-color: rgb(0, 0, 0) rgb(0, 0, 0) rgb(0, 0, 0) -moz-use-text-color; -moz-border-top-colors: none; -moz-border-right-colors: none; -moz-border-bottom-colors: none; -moz-border-left-colors: none; border-image: none; float: left;" class="mPastColor mNoLeftBorder" id="cell8">&nbsp;</div>
                <div style="background-color: rgb(0, 0, 0); height: 18px; width: 18px; border-width: 1px 1px 1px 0px; border-style: solid solid solid none; border-color: rgb(0, 0, 0) rgb(0, 0, 0) rgb(0, 0, 0) -moz-use-text-color; -moz-border-top-colors: none; -moz-border-right-colors: none; -moz-border-bottom-colors: none; -moz-border-left-colors: none; border-image: none; float: left;" class="mPastColor mNoLeftBorder" id="cell9">&nbsp;</div>
                <div style="clear: both;" class="mClear"></div>
            </div>
            <div style="background-image: url(&quot;http://meta100.github.com/mColorPicker/images/grid.gif&quot;); position: relative; height: 26px;" id="mColorPickerFooter"><input style="border: 1px solid gray; font-size: 10pt; margin: 3px; width: 80px;" id="mColorPickerInput" type="text"><span style="font-size: 16px; color: rgb(0, 0, 0); padding-right: 30px; padding-top: 3px; cursor: pointer; overflow: hidden; float: right;" class="mColor mColorTransparent" id="mColorPickerTransparent">transparent</span><a style="float: right;" target="_blank" alt="Meta100 - Designing Fun" title="Meta100 - Designing Fun" href="http://meta100.com/"><img style="border-width: 0px 0px 0px 1px; border-style: none none none solid; border-color: -moz-use-text-color -moz-use-text-color -moz-use-text-color rgb(170, 170, 170); -moz-border-top-colors: none; -moz-border-right-colors: none; -moz-border-bottom-colors: none; -moz-border-left-colors: none; border-image: none; right: 0px; position: absolute;" alt="Meta100 - Designing Fun" title="Meta100 - Designing Fun" src="kanban_archivos/meta100.png"></a></div>
        </div>
    </div>
    <div style="display: none;" id="mColorPickerTest"></div>
</div>
</body>
</html>
{% endblock %}

